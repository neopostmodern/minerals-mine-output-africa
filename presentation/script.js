const DATA = {
  DZA: {	Sn: 0, 	Cu: 0.00166666666666667, 	Zn: 0.00183333333333333, 	Au: 0.0000306859205776173, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  AGO: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  BHR: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  BEN: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0000072202166064982, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  BWA: {	Sn: 0, 	Cu: 0.00211111111111111, 	Zn: 0, 	Au: 0.000345848375451264, 	Ta: 0, 	Co: 0.00159349593495935, 	Pt: 0.00106741573033708, 	W: 0, 	Nb: 0, 	},
  BFA: {	Sn: 0, 	Cu: 0, 	Zn: 0.00541666666666667, 	Au: 0.0130685920577617, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  BDI: {	Sn: 0.000106666666666667, 	Cu: 0, 	Zn: 0, 	Au: 0.000180505415162455, 	Ta: 0.0161538461538462, 	Co: 0, 	Pt: 0, 	W: 0.000264367816091954, 	Nb: 0.000328125, 	},
  CPV: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  CMR: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.000541516245487365, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  CAF: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0000216606498194946, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  TCD: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0000433212996389892, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  COM: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  COG: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0000541516245487365, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  COD: {	Sn: 0.0216666666666667, 	Cu: 0.0572111111111111, 	Zn: 0.00121533333333333, 	Au: 0.0111913357400722, 	Ta: 0.284615384615385, 	Co: 0.536585365853659, 	Pt: 0, 	W: 0.000137931034482759, 	Nb: 0.006875, 	},
  CIV: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.00464332129963899, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  DJI: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  EGY: {	Sn: 0.00037, 	Cu: 0.000000166666666666667, 	Zn: 0, 	Au: 0.00423574007220217, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  GNQ: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.000180505415162455, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  ERI: {	Sn: 0, 	Cu: 0.00493888888888889, 	Zn: 0, 	Au: 0.000303249097472924, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  ETH: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.00418772563176895, 	Ta: 0.0461538461538462, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0.000153125, 	},
  GAB: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.000365342960288809, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  GMB: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  GHA: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0327631768953069, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  GIN: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.00612093862815884, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  GNB: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  IRN: {	Sn: 0, 	Cu: 0.0122222222222222, 	Zn: 0.0125, 	Au: 0.0011913357400722, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  IRQ: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  ISL: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  JOR: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  KEN: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0000722021660649819, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  KWT: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  LBN: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  LSO: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  LBR: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.000215884476534296, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  LBY: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  MDG: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0.0268292682926829, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  MWI: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  MLI: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0143407942238267, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  MRT: {	Sn: 0, 	Cu: 0.00183888888888889, 	Zn: 0, 	Au: 0.00347472924187726, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  MUS: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  MAR: {	Sn: 0, 	Cu: 0.000921055555555556, 	Zn: 0.00375, 	Au: 0.000121660649819495, 	Ta: 0, 	Co: 0.0113089430894309, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  MOZ: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0000711191335740072, 	Ta: 0.0176923076923077, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0.0000890625, 	},
  NAM: {	Sn: 0, 	Cu: 0.000291611111111111, 	Zn: 0.0130243333333333, 	Au: 0.000699638989169675, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  NER: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.000264259927797834, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  NGA: {	Sn: 0.00113333333333333, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0.146153846153846, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0.00034375, 	},
  OMN: {	Sn: 0, 	Cu: 0.000833333333333333, 	Zn: 0, 	Au: 0.0000072202166064982, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  QAT: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  REU: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  RWA: {	Sn: 0.0126666666666667, 	Cu: 0, 	Zn: 0, 	Au: 0.0000036101083032491, 	Ta: 0.3, 	Co: 0, 	Pt: 0, 	W: 0.0126436781609195, 	Nb: 0.00546875, 	},
  STP: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  SAU: {	Sn: 0, 	Cu: 0.000602777777777778, 	Zn: 0.00348366666666667, 	Au: 0.00172924187725632, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  SEN: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.00240649819494585, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  SYC: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  SLE: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0000155234657039711, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  SOM: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  ZAF: {	Sn: 0, 	Cu: 0.00486666666666667, 	Zn: 0.00217841666666667, 	Au: 0.0547371841155235, 	Ta: 0, 	Co: 0.024390243902439, 	Pt: 0.786516853932584, 	W: 0, 	Nb: 0, 	},
  SSD: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  SDN: {	Sn: 0, 	Cu: 0, 	Zn: 0.00000383333333333333, 	Au: 0.0264620938628159, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  SWZ: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  SYR: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  TZA: {	Sn: 0, 	Cu: 0.000319555555555556, 	Zn: 0, 	Au: 0.0156642599277978, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  TGO: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.00685920577617329, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  TUN: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  UGA: {	Sn: 0.000103333333333333, 	Cu: 0, 	Zn: 0, 	Au: 0.0000072202166064982, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0.000517241379310345, 	Nb: 0, 	},
  ARE: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0.0129963898916968, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  ESH: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  YEM: {	Sn: 0, 	Cu: 0, 	Zn: 0, 	Au: 0, 	Ta: 0, 	Co: 0, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  ZMB: {	Sn: 0, 	Cu: 0.0393333333333333, 	Zn: 0, 	Au: 0.00173285198555957, 	Ta: 0, 	Co: 0.0373983739837398, 	Pt: 0, 	W: 0, 	Nb: 0, 	},
  ZWE: {	Sn: 0, 	Cu: 0.000458944444444444, 	Zn: 0, 	Au: 0.00555415162454874, 	Ta: 0, 	Co: 0.00291056910569106, 	Pt: 0.0701292134831461, 	W: 0, 	Nb: 0, 	},
};

/* buttons */

const MINERALS = {
  "Co": "Cobalt",
  "Cu": "Copper",
  "Au": "Gold",
  "Nb": "Niobium/Columbium",
  "Ta": "Tantalum",
  "Sn": "Tin",
  "W": "Tungsten",
  "Pt": "Platinum",
  "Zn": "Zinc",
};
const NAMES = {
  'REST': {
    short: "Other African Countries",
    formal: "African countries with shares of 0.8% or less",
    suffix: ""
  },
  'NON_AFRICAN': {
    short: "Non-African Countries",
    formal: "",
    suffix: ""
  },
};
const DESCRIPTIONS = {
  "Co": `Compounds used: Cobalt oxide, cobalt hydroxide, cobalt metal.<br/><br/>
  Lithium Ion Batteries: used in every rechargeable device including mobile phones, tablets, laptops, electric cars, and other vehicles, batteries for all solar-powered technologies.  
Electric vehicles and hybrid electric vehicles, electric trains, electric bikes  Renewable energy power stations and home storage, ancillary services to electrical grid.</br><br/>
Portable devices - Mobile phones, laptops, tablets, cutting tools, Cobalt is used in three main parts within a semi-conductor.<br/><br/>
Cobalt's unique physico-chemical properties, including wear resistance and electrical resistivity, make it ideal for several different components within integrated circuits. Ccobalt is used in the packaging of ICs. Cobalt can be used in printing circuit board materials (PCB). PCBs usually consist of an insulating support surrounded by layers of electrically resistive materials which are attached to highly conductive materials.`,
  "Cu": "In integrated circuits, copper replaces aluminum in silicon chips for interconnection and lead frames. Vacuum electronic devices such as high frequency and ultra high frequency tubes,  magnetron, etc. Copper printed circuits require a lot of copper foil and copper base brazing material.",
  "Au": `Solid state electronic devices use very low voltages and currents which are easily interrupted by corrosion or tarnish at the contact points. Gold is the highly efficient conductor that can carry these tiny currents and remain free of corrosion. Electronic components made with gold are highly reliable. Gold is used in connectors, switch and relay contacts, soldered joints, connecting wires and connection strips.<br/><br/>
A small amount of gold is used in almost every sophisticated electronic device. This includes cell phones, calculators, personal digital assistants, global positioning system (GPS) units, and other small electronic devices. Most large electronic appliances such as television sets also contain gold.`,
  "Nb": `Niobium capacitors for electronic circuits because of high dielectric constant, stability of oxide dielectric.<br/>
Niobium-tin alloy: Superconducting magnetic coils in magnetic resonance imagery (MRI), magnetoencephalography, magnetic levitation transport systems, particle physics experiments.<br/>
Experimental Quantum Computer Chips (Qbits)`,
  "Ta": `Capacitors because of its ability to hold an electrical charge. Even though the quantity used in each capacitor is very small this is a very signicant application because an average mobile phone contains 23 tantalum capacitors.<br/>
  Lithium tantalate is a chemical compound with unique optical, piezoelectric and pyroelectric properties,  used in the manufacture of electronic components, such as capacitors and surface acoustic wave filters, which are employed in devices such as mobile phones, motion detectors and laser switching devices, used in range finding applications. It is also used in touchscreen technologies.`,
  "Sn": `Lead-Free Solder<br/>Corrosion resistant cabling`,
  "W": `Tungsten hexafluoride is widely used in the semiconductor industry for depositing metal on semiconductor circuits and circuit boards  as a barrier between silicon and tungsten in semiconductors.<br/>
Tungsten Diselenide, WSe2  is used for thin-film materials for solar cells, exceptional promise for photovoltaic applications`,
  "Pt": `The versatile platinum group metals (PGMs)—platinum, palladium, rhodium, iridium, ruthenium and osmium—can be found in your computer and in the glass of your computer screen, used in virtually every kind of electronic device, from basic consumer products to complex military hardware.  Palladium is used for multi-layer ceramic (chip) capacitors (MLCC). MLCCs store energy in electronic devices such as broadcasting equipment, mobile telephones, computers, electronic lighting and high voltage circuits.`,
  "Zn": "ZnO films for photovoltaic (PV), and optoelectronic devices, organic light emitting diodes and third-generation PV cells.",
};

let mineral = "Co";

const width = 900;
const height = 1000;

const svg = d3.select("div.svg").append("svg")
    .attr("width", width)
    .attr("height", height);

const formatValue = d3.format(".1%");
const formatPercentage = d3.format(".2%");

const colorScale = d3.scale.log()
    .domain([0.001, 0.5])
    .range(["navy", "red"]);

function yieldDataset() {
  let sum = 0;
  let rest = 0;
  let dataset = [];
  Object.entries(DATA).forEach(([ia3, values]) => {
    let value = values[mineral];
    sum += value;
    if (value > 0.008) {
      dataset.push({
        ia3,
        value: values[mineral]
      });
    } else {
      rest += value;
    }
  });
  dataset.push({
    ia3: "REST",
    value: rest
  });
  dataset.push({
    ia3: "NON_AFRICAN",
    value: 1 - sum
  });
  return dataset;
}

let pieG;

function drawPie() {
  if (pieG) {
    let oldPie = pieG.pop()[0];
    oldPie.remove();
  }

  const width = 300;
  const height = 300;
  const radius = Math.min(width, height) / 2;
  pieG = svg.append("g").attr("transform", "translate(" + (width / 2 + 50) + "," + (height / 2 + 600) + ")");

  const pie = d3.pie()
      .sort(function (a, b) {
        if (b.ia3 === 'REST') {
          return 1;
        }

        return a.value - b.value;
      })
      .value(function (d) {
        return d.value;
      });

  pieG.append("circle")
      .attr("r", radius + 2)
      .attr("stroke", "black")
      .attr("fill", "white");

  const path = d3.arc()
      .outerRadius(radius)
      .innerRadius(0);

  const arc = pieG.selectAll(".arc")
      .data(pie(yieldDataset()))
      .enter().append("g")
      .attr("class", "arc");

  const arc_path = arc.append("path")
      .attr("d", path)
      .attr("fill", function (d) {
        if (d.data.ia3 === 'NON_AFRICAN') {
          return 'white';
        }
        if (d.data.ia3 === 'REST') {
          return 'gray'
        }
        return colorScale(d.data.value);
      });
  // .attr("style", (d) => d.data.ia3 === 'Non-african' ? "stroke: black;" : "")

  arc_path.on("mouseover", function (d, i) {
    tooltip.show(`
      <div class="tooltip-amount"><div class="tooltip-amount-number">${formatPercentage(d.data.value)}</div></div>
      <div>${MINERALS[mineral]}<br/><b>${NAMES[d.data.ia3].short} ${NAMES[d.data.ia3].suffix}</b><br/> ${NAMES[d.data.ia3].formal}</div>
    `);
  });
  arc_path
      .on("mousemove", function (d, i) {
        tooltip.move();
      })
      .on("mouseout", function (d, i) {
        tooltip.hide();
      });
}

let data;
let legend;
let title;
const tooltip = {
  element: null,
  init: function () {
    this.element = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);
  },
  show: function (t) {
    this.element.html(t).transition().duration(200).style("left", d3.event.pageX + 20 + "px").style("top", d3.event.pageY - 20 + "px").style("opacity", .9);
  },
  move: function () {
    let left = "";
    let right = "";
    if (d3.event.pageX / window.innerWidth < 0.7) {
      left = d3.event.pageX + 20 + "px";
    } else {
      right = (window.innerWidth - d3.event.pageX + 20) + "px";
    }

    this.element
        .transition()
        .duration(30)
        .ease("linear")
        .style("left", left)
        .style("right", right)
        .style("top", d3.event.pageY - 20 + "px")
        .style("opacity", .9);
  },
  hide: function () {
    this.element.transition().duration(500).style("opacity", 0)
  }
};

tooltip.init();

function drawAxis() {
  // A position encoding for the key only.
  const x = d3.scale.log()
      .domain([0.001, 0.5])
      .range([0, 700]);

  const xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom")
      .tickSize(17)
      .tickValues([0.001, 0.005, 0.01, 0.05, 0.1, 0.2, 0.3, 0.5])
      .tickFormat(function (d) {
        return formatValue(d)
      });

  //Append a defs (for definition) element to your SVG
  const defs = svg.append("defs");

  //Append a linearGradient element to the defs and give it a unique id
  const linearGradient = defs.append("linearGradient")
      .attr("id", "linear-gradient");

  //Set the color for the start (0%)
  linearGradient.append("stop")
      .attr("offset", "0%")
      .attr("stop-color", "navy");

  //Set the color for the end (100%)
  linearGradient.append("stop")
      .attr("offset", "100%")
      .attr("stop-color", "red");

  // key
  legend = svg.append("g")
      .attr("class", "key")
      .attr("transform", "translate(65,50)");

  legend.append("rect")
      .attr("width", 700)
      .attr("height", 14)
      .style("fill", "url(#linear-gradient)");

  title = legend.call(xAxis).append("text")
      .attr("class", "caption")
      .attr("y", -6);
  // key end

  const g2 = svg.append("g")
      .attr("transform", "translate(15,50)");

  g2.append("rect")
      .attr("x", 5)
      .attr("width", 14)
      .attr("height", 14)
      .style("fill", "black");

  g2.append("text")
      .attr("x", -3)
      .attr("y", 27)
      .attr("font-size", 10)
      .text("<0.1%");


  const g3 = svg.append("g")
      .attr("transform", "translate(15,90)");

  g3.append("rect")
      .attr("x", 5)
      .attr("width", 14)
      .attr("height", 14)
      .style("fill", "lightgray");

  g3.append("text")
      .attr("x", -8)
      .attr("y", 27)
      .attr("font-size", 10)
      .text("No data")
}

function getData(a3_code, mineral_code) {
  if (DATA[a3_code]) {
    return DATA[a3_code][mineral_code];
  }

  return null;
}

let countries;

function draw() {
  const projection = d3.geo.azimuthalEqualArea()
      .center([15, 5])
      .scale(600)
      .translate([width / 2, height / 2]);

  const path = d3.geo.path()
      .projection(projection);

  d3.selectAll(".subunit").remove();

  const map = svg.append("g")
      .attr("class", "map");

  countries = map.selectAll(".subunit")
      .data(topojson.feature(data, data.objects.collection).features)
      //.data(topojson.feature(uk, uk.objects.subunits).features)
      .enter().append("path")
      .attr("class", function (d) {
        return "subunit " + d.properties.subunit;
      })
      .attr("d", path);

  countries.on("mouseover", function (d, i) {
    var admin = "";
    if (d.properties.formal_en && d.properties.formal_en != d.properties.subunit) {
      admin += `<br /><i>${d.properties.formal_en}</i>`;
    }
    if (d.properties.sovereignt !== d.properties.subunit && d.properties.sovereignt !== d.properties.formal_en || d.name_long) {
      admin = `<br /><i>${d.properties.sovereignt}</i>`;
    }

    let amount;
    if (DATA[d.properties.adm0_a3]) {
      amount = `<div class="tooltip-amount-number">${formatPercentage(DATA[d.properties.adm0_a3][mineral])}</div> `;
    } else {
      amount = "<i>No data</i>";
    }
    tooltip.show(`
        <div class="tooltip-amount">${amount}</div>
        <div>${MINERALS[mineral]}<br/><b>${d.properties.subunit}</b>${NAMES[d.properties.adm0_a3].suffix} ${admin || "&nbsp;"}</div>
      `);
  });


  countries.on("mousemove", function (d, i) {
    tooltip.move();
  })
      .on("mouseout", function (d, i) {
        tooltip.hide();
      });

  map.append("path")
      .datum(topojson.mesh(data, data.objects.collection, function (a, b) {
        return a !== b;
      }))
      .attr("d", path)
      .attr("class", "subunit-boundary");
}

function redraw() {
  countries
      .style("fill", function (d, i) {
        let amount = getData(d.properties.adm0_a3, mineral);
        if (amount === null) {
          return 'lightgray';
        }
        if (amount < 0.001) {
          return 'black';
        }
        return colorScale(amount);
      });

  title.text(`${MINERALS[mineral]} (${mineral}) mine outputs across Africa`);
}

d3.json("/static/africaTopoMap.json", function (error, mapData) {
  if (error) {
    alert("Failed to load map.");
    return console.error(error);
  }

  mapData.objects.collection.geometries.forEach(({properties}) => {
    let suffix = "";
    if (properties.adm0_a3 === 'COD') {
      suffix = ' [Kinshasa]';
    } else if (properties.adm0_a3 === 'COG') {
      suffix = ' [Brazzaville]'
    }

    NAMES[properties.adm0_a3] = {
      short: properties.name,
      long: properties.sovereignt,
      formal: properties.formal_en,
      suffix
    };
  });

  data = mapData;

  drawAxis();
  draw();
  redraw();

  drawPie();

  listCountries();
  updateDescription();
});

const mineralButtons = [];

function redrawButtons() {
  mineralButtons.forEach(button => {
    button.className = button.dataset.mineral === mineral ? 'selected' : '';
  })
}

function listCountries() {
  document.getElementById('mineral-countries').innerHTML = Object.entries(DATA)
      .filter(([ia3, country]) =>
          country[mineral] > 0 && NAMES[ia3]
      )
      .sort(([a_ia3, a_country], [b_ia3, b_country]) => b_country[mineral] - a_country[mineral])
      .map(([ia3, country]) => `
      <tr>
        <td title="${NAMES[ia3].formal}">
          ${NAMES[ia3].short} ${NAMES[ia3].suffix}
        </td>
        <td style="text-align: right;">${formatPercentage(country[mineral])}</td>
      </tr>`
      )
      .join("");
}

function updateDescription() {
  document.getElementById('mineral-description').innerHTML = DESCRIPTIONS[mineral];
}

const onload = () => {
  mineralButtonsContainer = document.getElementById('mineral-buttons');
  Object.entries(MINERALS).forEach(([element, name]) => {
    const button = document.createElement('button');
    button.type = 'button';
    button.innerHTML = name;
    button.dataset.mineral = element;
    button.onclick = () => {
      mineral = element;
      redraw();
      redrawButtons();

      drawPie();

      listCountries();
      updateDescription();
    };

    mineralButtons.push(button);
    mineralButtonsContainer.appendChild(button);
  });

  redrawButtons();
};

if (document.readyState === 'complete') {
  onload();
} else {
  addEventListener("load", onload);
}